# -*- coding: utf-8 -*-
from __future__ import absolute_import, unicode_literals

import os
import re

import mwparserfromhell
import pytest

from textacy import compat
from textacy.datasets import wikipedia


DATASET = wikipedia.Wikipedia(lang="en", version="latest")

TEST_RAW_ITEM = {
    "page_id": "37711314",
    "title": "Decay (2012 film)",
    "text": '{{Use dmy dates|date=April 2016}}\n{{Use British English|date=April 2016}}\n{{missing information|the film\'s reception|date=February 2015}}\n{{Infobox film\n| name           = Decay\n| image          = Decay 2012 Movie Poster.jpg\n| alt            = \n| caption        = \n| director       = Luke Thompson\n| producer       = Michael Mazur<br>Luke Thompson<br>Burton DeWilde\n| writer         = \n| starring       = Zoë Hatherell<br>Tom Procter<br>Stewart Martin-Haugh<br>Sara Mahmoud<br>William P.Martin\n| music          = Tom McLaughlan\n| cinematography = \n| editing        = Burton DeWilde\n| studio         = \n| distributor    = \n| released       = {{Film date|2012|11|29|df=y}}\n| runtime        = 75 minutes<ref>{{cite web|first=Werner |last=Pluta|title=DecayZombies im Cern|url=http://www.golem.de/news/decay-zombies-im-cern-1211-95464.html|publisher=Golem.de|date=1 November 2012|accessdate=22 November 2012}}</ref> \n| country        = Switzerland\n| language       = English\n| budget         = \n| gross          = \n}}\n\'\'\'\'\'Decay\'\'\'\'\' is a 2012 [[horror film]] by Luke Thompson (of the [[University of Manchester]]), set at the [[Large Hadron Collider]] in [[Switzerland]].<ref>{{cite web|url=http://www.popsci.com/science/article/2012-10/physics-students-film-zombie-movie-large-hadron-collider|title=Large Hadron Collider Unleashes Rampaging Zombies|last=Boyle|first=Rebecca|work=[[Popular Science]]|date=31 October 2012|accessdate=22 November 2012}}</ref><ref>{{cite web|last=Ranzini|first=Gianluca|title=Zombie al Cern di Ginevra!|url=http://www.focus.it/curiosita/zombie-al-cern-di-ginevra_C7.aspx|work=[[Focus (Italian magazine)|Focus]]|date=5 November 2012|accessdate=22 November 2012}}</ref> The movie was created on a budget of $3,225 and was filmed over a period of two years by Thompson and his fellow physicists.<ref>{{cite web|title=Nuclear lab facility becomes movie set for students\' zombie film|url=http://www.gmanetwork.com/news/story/280792/scitech/technology/nuclear-lab-facility-becomes-movie-set-for-students-zombie-film|publisher=[[GMA News]]|date=3 November 2012|accessdate=22 November 2012}}</ref> The film was released online for free under the [[Creative Commons license|Creative Commons]] [[CC BY-NC]] license, shareable and [[Remix culture|remixable]].<ref name=Wired/><ref name=Mashable>{{cite web|last=Ouellette|first=Jennifer|title=Horror Movie Chronicles CERN Zombie Apocalypse|url=http://mashable.com/2012/11/19/decay-cern-zombie/|publisher=[[Mashable]]|date=19 November 2012|accessdate=22 November 2012}}</ref> \'\'Decay\'\' was premiered on 29 November 2012 and centres on the idea of the Large Hadron Collider transforming scientists into [[Zombie (fictional)|zombies]].<ref name=FN1>{{cite web|last=Wax|first=Alyse|title=Zombies Get Brainy in Upcoming Large Hadron Collider Movie \'Decay\'|url=http://www.fearnet.com/news/news-article/zombies-get-brainy-upcoming-large-hadron-collider-movie-decay|publisher=[[Fearnet]]|date=14 November 2012|accessdate=22 November 2012}}</ref>\n\nThompson, a physics doctoral student, came up with the idea of the film while he was walking through the maintenance tunnels at [[CERN]] and began thinking that it would be a good location for a horror movie.<ref name=Mashable /> In an interview with \'\'[[Wired (magazine)|Wired]]\'\', he stated that the film was initially started for fun, but that it was also an opportunity to "do some satirical commentary on various aspects of people’s perceptions of science".<ref name=Wired>{{cite web|last=Wattercutter|first=Angela|title=Physics Students Make Zombie Movie Decay Deep Within the Bowels of CERN|url=https://www.wired.com/underwire/2012/10/cern-zombie-movie-decay/|work=[[Wired (magazine)|Wired]]|date=31 October 2012|accessdate=22 November 2012}}</ref>\n\n==Plot==\nA security guard is walking along the maintenance tunnel of the [[Large Hadron Collider]] (LHC) at [[CERN]] when he turns around, meets an unidentified man whom he recognizes, and  informs him that he is not supposed to be down there. The man proceeds to shoot the guard dead.\n\nConnor, James, Amy, and Matt are [[physicist]]s at CERN working on the Large Hadron Collider. James works with the LHC, while the others analyze the data generated by it. They are on their way to attend an emergency meeting at CERN. They have no idea why the meeting was called, but Amy believes it can\'t be very important. At CERN, they overhear Dr. Niven and the Director General arguing over safety. Dr. Niven wants the LHC to be stopped till he can assess the safety, but the Director General overrides his concerns and informs him that, once the problem is fixed, the LHC would work normally and finding the [[Higgs boson]] is of utmost importance. The Director General realizes that Connor, James and Amy are listening to them and he asks the security guard to shut the door.\n\nAt the conference room they meet Lisa, who was supposed to be in [[Barcelona]] for a conference but missed her flight due to the party. The Director General addresses the attendees and informs them that the previous night there was a beam dump in LHC. The beam dump occurred because the beam sensors had detected that the [[monopole magnet]] at LHC segment 11G had quenched due to an unknown event. He further warns that, if the event occurs again, there could be a catastrophic accident. Dr. Niven is selected to take a team of technicians down to the LHC tunnel to investigate the cause of the incident and try to get the LHC running again. The Director General requests four volunteers to be in the control room while Dr. Niven is busy. Connor volunteers for the task and the Director General selects Connor, James, Amy and Lisa. Lisa bails out, informing the Director General that she has to attend a conference in Barcelona, so Matt is selected instead.\n\nJames introduces his girlfriend Kate to Connor, Amy and Matt. Amy uses the [[mainframe computer]] to run a simulation of the impact of Higgs boson radiation on human tissues. As Amy runs the simulation on the mainframe, the LHC beam monitor indicates that the LHC is up and running. James checks the system and realizes that the system has turned on by itself and Amy had nothing to do with it.\n\nThe team led by Dr. Niven is still in the maintenance tunnel of the LHC and they are at risk of being exposed to radiation. James and Connor try to shut down the LHC, but they are unsuccessful; the emergency shutdown switch is not working. The radiation alarm goes off and they decide to run away to avoid being exposed to the radiation. The elevator near the control room is not working and there is no mobile signal since they are over hundred meter underground. They decide to go down to the maintenance tunnel and James manually shuts down the LHC. Connor informs the group that the LHC cannot be turned on from the control room and neither do they have access rights to turn on the LHC. Since the LHC is now off, they can use the elevator in the maintenance tunnel to get out; they believe that the team led by Dr. Niven is dead due to radiation.\n\nAs they walk through the maintenance tunnel, they are attacked by the technicians of the team led by Dr. Niven and Kate is captured. Connor, Amy, James and Matt lock themselves up in a room and James uses the [[coolant]] to scare away the technicians. Amy and Connor realize that the technicians had radiation burn marks on their skin and cannot comprehend how the technicians are still alive. Connor finds another way out of the room and they head back into the maintenance tunnel, where they find the dead body of the security guard killed at the beginning of the movie. They find the interlock array and see that it has been destroyed, which indicates sabotage. They are again attacked by the technicians, so they decide to find a mainframe to contact somebody for help. On their way, they are attacked again and this time James is bitten.\n\nThey finally find the mainframe server room, James wants to check if Kate is still alive. Amy and Connor work on the mainframe consoles to breach the [[firewall (computing)|firewall]] to ask for help, but are unsuccessful. Finally, the results of Amy\'s simulations come up; they indicate that the boson radiation has the capability to destroy human brain. This makes them realize that the technicians are all dead and have become [[zombie]] like. Amy and James head back into the maintenance tunnel, where they find the Director General\'s security guard is dead. James recovers a gun from the guard. Finally, they find Kate\'s dead body, which the zombies have mutilated. Meanwhile, Connor is studying the simulation data when somebody triggers a deletion of the results. Amy and James return to the mainframe server room, where Connor informs them that only the Director General has the rights to delete the data.\n\nJames and Connor manage to unlock all the doors using the mainframe console. Finally, James succumbs to his injury and turns into a zombie, attacking the others. Matt bolts, leaving Connor and Amy to defend themselves. Connor shoots James. Amy and Connor go back to the maintenance tunnel and are attacked by the zombies. Connor is bitten and Amy shoots him when he turns. Zombies escape the maintenance tunnel through the unlocked doors and attack people outside. Amy is chased by zombies, but she manages to elude them. Matt is attacked and eaten alive by the zombies.\n\nAmy manages to reach the surface and is chased by the zombies. She goes to Dr. Niven\'s office to collect data about his simulation to collect evidence against the Director General. She calls up Lisa on her mobile to inform her that the Director General is responsible for the deaths at CERN, but she is redirected to her voice mail. The Director General enters Dr. Niven\'s office, picks up the gun left behind by Amy and points it at her. Amy manages to get a confession out of the Director General; as he is about to pull the trigger it is shown that Amy had not disconnected the call and that the confession has gone to Lisa\'s voice mail. The screen goes black and the sound of a gunshot is heard.\n\n==Cast==\n*Zoë Hatherell as Amy\n*Tom Procter as Connor \n*Stewart Martin-Haugh as James \n*Sara Mahmoud as Kate \n*William P. Martin as Matt\n*Eduard Friesen as Director General\n*Kurt Rinnert as Dr. Niven\n*Jenn Strauss as Lisa\n\n==Production==\nThompson began filming in 2010 and took two years to complete \'\'Decay\'\',<ref>{{cite web|last=Dacey|first=James|title=Zombies in the machine|url=http://physicsworld.com/blog/2012/10/zombies_in_the_machine.html|publisher=[[Physics World]]|date=31 October 2012|accessdate=22 November 2012}}</ref> with the film\'s crew having to borrow cameras and create special effects on a limited budget.<ref name=Wired /> CERN gave permission for \'\'Decay\'\' to be filmed at the research center with the stipulation that they not film in any of the facility\'s more sensitive areas.<ref name=Wired />\n\n==Release==\n\nA film trailer was released in the autumn of 2012,<ref>{{cite web|first=Adario |last=Strange|title=Students take over Large Hadron Collider to shoot a zombie film|url=http://dvice.com/archives/2012/10/students-take-o.php|publisher=[[Dvice.com|DVice]]|date=29 October 2012|accessdate=22 November 2012}}</ref> with some sites such as [[Fearnet]] commenting that while the film did not look particularly good, the premise of \'\'Decay\'\' was an interesting one.<ref name=FN1 />\n\nDecay was released on 8 December 2012 <ref>{{cite web|title=Decay released online|url=http://www.decayfilm.com/2012/decay-released-online.html|work=Decay Official Website|accessdate=11 May 2013}}</ref> for download and streaming via YouTube and Vimeo.\n\n==References==\n{{Reflist|30em}}\n\n==External links==\n* {{Official website|http://www.decayfilm.com}}\n* {{IMDb title|2523692|Decay}}\n* {{Internet Archive film|id=Decay2012-TheLhcZombieFilmfullFilm}}\n\n[[Category:British horror films]]\n[[Category:British films]]\n[[Category:2012 horror films]]\n[[Category:Films shot in Switzerland]]\n[[Category:2012 films]]\n[[Category:Student films]]\n[[Category:Zombie films]]\n[[Category:Creative Commons-licensed films]]'
}


@pytest.fixture(scope="module")
def text_fast():
    return wikipedia.strip_markup(TEST_RAW_ITEM["text"], True)


@pytest.fixture(scope="module")
def text_fast_noheadings():
    return wikipedia.strip_markup(TEST_RAW_ITEM["text"], False)


@pytest.fixture(scope="module")
def text_slow():
    return wikipedia.strip_markup_slow(
        TEST_RAW_ITEM["text"], True, mwparserfromhell.parser.Parser())


@pytest.fixture(scope="module")
def text_slow_noheadings():
    return wikipedia.strip_markup_slow(
        TEST_RAW_ITEM["text"], False, mwparserfromhell.parser.Parser())


@pytest.mark.skipif(
    DATASET.filepath is None,
    reason="Wikipedia dataset must be downloaded before running tests",
)
class TestWikipedia(object):

    @pytest.mark.skip("No need to download a new dataset every time")
    def test_download(self, tmpdir):
        dataset = wikipedia.Wikipedia(data_dir=str(tmpdir))
        dataset.download()
        assert os.path.exists(dataset.filepath)

    def test_oserror(self, tmpdir):
        dataset = wikipedia.Wikipedia(data_dir=str(tmpdir))
        with pytest.raises(OSError):
            _ = list(dataset.texts())

    def test_texts(self):
        texts = list(DATASET.texts(limit=3))
        assert len(texts) > 0
        for text in texts:
            assert isinstance(text, compat.unicode_)

    def test_texts_slow(self):
        texts = list(DATASET.texts(fast=False, limit=3))
        assert len(texts) > 0
        for text in texts:
            assert isinstance(text, compat.unicode_)

    def test_texts_limit(self):
        for limit in (1, 5, 10):
            assert sum(1 for _ in DATASET.texts(limit=limit)) == limit

    def test_texts_min_len(self):
        for min_len in (100, 200, 500):
            assert all(
                len(text) >= min_len
                for text in DATASET.texts(min_len=min_len, limit=10)
            )

    def test_records(self):
        for text, meta in DATASET.records(limit=3):
            assert isinstance(text, compat.unicode_)
            assert isinstance(meta, dict)

    def test_records_slow(self):
        for text, meta in DATASET.records(fast=False, limit=3):
            assert isinstance(text, compat.unicode_)
            assert isinstance(meta, dict)

    def test_records_limit(self):
        for limit in (1, 5, 10):
            assert sum(1 for _ in DATASET.records(limit=limit)) == limit

    def test_records_min_len(self):
        for min_len in (100, 200, 500):
            assert all(
                len(text) >= min_len
                for text, meta in DATASET.records(min_len=min_len, limit=10)
            )

    def test_records_headings(self):
        for text, meta in DATASET.records(include_headings=True, limit=3):
            assert text.startswith(meta["title"])


class TestStripMarkupFast(object):

    def test_include_headings(self, text_fast, text_fast_noheadings):
        headings = (
            "Plot", "Cast", "Production", "Release", "References", "External links")
        for heading in headings:
            pattern = r"^{}$".format(heading)
            assert re.search(pattern, text_fast, flags=re.M) is not None
            assert re.search(pattern, text_fast_noheadings, flags=re.M) is None

    def test_markup_span_removal(self, text_fast):
        assert re.search(r"{{|}}", text_fast) is None
        assert re.search(r"\[\[|\]\]", text_fast) is None
        assert wikipedia.re_ext_link.search(text_fast) is None

    def test_text_formatting_removal(self, text_fast):
        assert wikipedia.re_italic_quote.search(text_fast) is None
        assert wikipedia.re_bold_italic.search(text_fast) is None
        assert wikipedia.re_quote_quote.search(text_fast) is None


class TestStripMarkupSlow(object):

    def test_include_headings(self, text_slow, text_slow_noheadings):
        headings = (
            "Plot", "Cast", "Production", "Release", "References", "External links")
        for heading in headings:
            pattern = r"^{}$".format(heading)
            assert re.search(pattern, text_slow, flags=re.M) is not None
            assert re.search(pattern, text_slow_noheadings, flags=re.M) is None

    def test_markup_span_removal(self, text_slow):
        assert re.search(r"{{|}}", text_slow) is None
        assert re.search(r"\[\[|\]\]", text_slow) is None
        assert wikipedia.re_ext_link.search(text_slow) is None

    def test_text_formatting_removal(self, text_slow):
        assert wikipedia.re_italic_quote.search(text_slow) is None
        assert wikipedia.re_bold_italic.search(text_slow) is None
        assert wikipedia.re_quote_quote.search(text_slow) is None
